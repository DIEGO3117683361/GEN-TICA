

<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A S C L E P I O</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f5f5f7;
            --text-primary: #1d1d1f;
            --accent: #828282;
            --border-color: #d2d2d7;
            --message-bg: #ffffff;
            --user-message-bg: #f5f2ed;
            --user-message-text: #000000;
            --vision-gradient: linear-gradient(45deg, #696969, #000000, #373737, #000000);
            --welcome-color: #888888;
            --image-btn-color: #FF6B6B;
            --code-btn-color: #4ECDC4;
            --analyze-btn-color: #FFD166;
            --attachment-indicator-bg: #e8b923;
            --attachment-active-bg: #4CAF50;
        }

        [data-theme="dark"] {
            --primary-bg: #1d1d1f;
            --secondary-bg: #2c2c2e;
            --text-primary: #f5f5f7;
            --accent: #828282;
            --border-color: #48484a;
            --message-bg:#1d1d1f;
            --user-message-bg: #2e2e2e;
            --user-message-text: #ffffff;
            --vision-gradient: linear-gradient(45deg, #a1a1a1, #4a4a4a, #7d7d7d, #4a4a4a);
            --welcome-color: #666666;
            --attachment-indicator-bg: #c49a1d;
            --attachment-active-bg: #388E3C;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: auto; /* ✅ o directamente elimínalo si no es esencial */
        }

        .sidebar {
            width: 280px;
            background-color: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            position: absolute;
            height: 100%;
            z-index: 100;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-visible {
            transform: translateX(0);
            box-shadow: 10px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
        }

        .sidebar-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .new-chat-button {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
            justify-content: center;
        }

        .new-chat-button:hover {
            opacity: 0.9;
        }

        .chats-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .chat-item {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .chat-item:hover {
            background-color: var(--primary-bg);
        }

        .chat-item:hover .delete-chat {
            display: block;
        }

        .chat-item-icon {
            width: 20px;
            height: 20px;
            background-color: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            flex-shrink: 0;
        }

        .delete-chat {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-primary);
            opacity: 0.5;
            cursor: pointer;
            display: none;
        }

        .delete-chat:hover {
            opacity: 1;
        }

        .sidebar-footer {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            position: relative;
        }

        .vision-sidebar-button {
            position: relative;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--vision-gradient);
            background-size: 300% 300%;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            overflow: hidden;
            animation: aurora 8s ease infinite;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .vision-sidebar-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            right: -50%;
            bottom: -50%;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        .vision-sidebar-button:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
        }

        .vision-tooltip {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid var(--border-color);
        }

        .vision-sidebar-button:hover .vision-tooltip {
            opacity: 1;
        }

        .vision-link {
            color: inherit;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            height: 100%;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .menu-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }

        .menu-button:hover {
            background-color: var(--secondary-bg);
        }

        .settings-menu {
            position: relative;
        }

        .settings-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }

        .settings-button:hover {
            background-color: var(--secondary-bg);
        }

        .settings-dropdown {
            position: absolute;
            right: 0;
            top: 50px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 200px;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .settings-dropdown.visible {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .dropdown-item:hover {
            background-color: var(--primary-bg);
        }

        .chat-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        .attachment-indicator {
            position: sticky;
            top: 0;
            background-color: var(--attachment-indicator-bg);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            margin: 0 auto;
            max-width: 300px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            font-size: 14px;
        }

        .attachment-indicator.visible {
            display: flex;
        }

        .attachment-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 200px;
        }

        .attachment-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
        }

        .attachment-close:hover {
            opacity: 0.8;
        }

        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
            animation: fadeIn 0.3s ease-out;
            position: relative;
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--message-bg);
            border-bottom-left-radius: 4px;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-message-bg);
            color: var(--user-message-text);
            border-bottom-right-radius: 4px;
        }

        .message-attachment-indicator {
            font-size: 12px;
            opacity: 0.7;
            display: flex;
            align-items: center;
        }

        .copy-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .copy-button {
            opacity: 0.7;
        }

        .copy-button:hover {
            opacity: 1 !important;
        }

        .welcome-message {
            text-align: center;
            margin: auto;
            color: var(--welcome-color);
            padding: 20px;
            max-width: 500px;
        }

        .welcome-title {
            font-weight: bold;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .welcome-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .welcome-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: #000;
            font-weight: 500;
        }

        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .welcome-btn-image {
            background-color: var(--image-btn-color);
        }

        .welcome-btn-code {
            background-color: var(--code-btn-color);
        }

        .welcome-btn-analyze {
            background-color: var(--analyze-btn-color);
        }

        .btn-icon {
            width: 18px;
            height: 18px;
        }

        .html-container {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .html-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .html-toolbar-title {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .html-toolbar-buttons {
            display: flex;
            gap: 6px;
        }

        .html-toolbar-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .html-toolbar-btn:hover {
            background-color: var(--primary-bg);
        }

        .html-content {
            padding: 12px;
            background-color: var(--primary-bg);
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .html-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .html-preview-modal.visible {
            opacity: 1;
            pointer-events: all;
        }

        .html-preview-content {
            position: relative;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            background-color: var(--primary-bg);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .html-preview-header {
            padding: 12px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .html-preview-title {
            font-weight: bold;
        }

        .close-preview {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
        }

        .html-preview-iframe {
            flex: 1;
            border: none;
            background-color: white;
        }

        .typing-indicator {
            display: inline-flex;
            gap: 6px;
            padding: 12px 16px;
            background-color: var(--message-bg);
            border-radius: 18px;
            align-self: flex-start;
            margin-bottom: 16px;
            border-bottom-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .image-loading {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 20px;
            background-color: var(--message-bg);
            border-radius: 18px;
            margin-bottom: 16px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .sketch-container {
            position: relative;
            width: 120px;
            height: 80px;
            margin-bottom: 10px;
        }

        .sketch-pencil {
            position: absolute;
            left: 0;
            top: 20px;
            width: 20px;
            height: 4px;
            background-color: var(--accent);
            transform-origin: left center;
            animation: pencilMove 2s infinite ease-in-out;
        }

        .sketch-pencil::before {
            content: '';
            position: absolute;
            right: -4px;
            top: -2px;
            width: 8px;
            height: 8px;
            background-color: var(--accent);
            transform: rotate(45deg);
        }

        .sketch-line {
            position: absolute;
            height: 2px;
            background-color: var(--accent);
            opacity: 0;
            animation: sketchLine 2s infinite;
        }

        .sketch-line:nth-child(2) {
            top: 20px;
            left: 20px;
            width: 0;
            animation-delay: 0.2s;
        }

        .sketch-line:nth-child(3) {
            top: 40px;
            left: 10px;
            width: 0;
            animation-delay: 0.4s;
        }

        .sketch-line:nth-child(4) {
            top: 60px;
            left: 30px;
            width: 0;
            animation-delay: 0.6s;
        }

        .sketch-line:nth-child(5) {
            top: 30px;
            left: 50px;
            width: 0;
            animation-delay: 0.8s;
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-primary);
            margin-top: 8px;
        }

        @keyframes pencilMove {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(30px) rotate(10deg); }
            50% { transform: translateX(60px) rotate(-5deg); }
            75% { transform: translateX(90px) rotate(5deg); }
        }

        @keyframes sketchLine {
            0% { opacity: 0; width: 0; }
            20% { opacity: 1; width: 0; }
            40% { opacity: 1; width: 40px; }
            60% { opacity: 1; width: 40px; }
            80% { opacity: 0; width: 40px; }
            100% { opacity: 0; width: 0; }
        }

        .document-processing {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 20px;
            background-color: var(--message-bg);
            border-radius: 18px;
            margin-bottom: 16px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .doc-scanner {
            position: relative;
            width: 120px;
            height: 80px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 10px;
        }

        .scanner-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--accent);
            animation: scan 2s infinite ease-in-out;
        }

        @keyframes scan {
            0% { transform: translateY(0); }
            50% { transform: translateY(76px); }
            100% { transform: translateY(0); }
        }

        .document-success {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background-color: var(--message-bg);
            border-radius: 18px;
            margin-bottom: 16px;
            border-bottom-left-radius: 4px;
            width: fit-content;
            max-width: 75%;
            font-size: 15px;
        }

        .success-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
        }

        .success-close:hover {
            opacity: 0.8;
        }

        .generated-image-container {
            max-width: 100%;
            margin: 10px 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .generated-image {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .generated-image:hover {
            transform: scale(1.02);
        }

        .download-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }

        .generated-image-container.active .download-button {
            opacity: 1;
        }

        .download-button:hover {
            opacity: 1;
        }

        .image-prompt {
            padding: 8px 12px;
            background-color: var(--secondary-bg);
            font-size: 13px;
            color: var(--accent);
            border-top: 1px solid var(--border-color);
        }

        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .image-modal.visible {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-container {
            padding: 16px 24px;
            background-color: transparent;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            max-width: 800px;
            width: 100%;
            background-color: var(--secondary-bg);
            border-radius: 32px;
            padding: 8px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s;
        }

        .input-wrapper:focus-within {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .input-box {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background-color: transparent;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
        }

        .attachment-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .attachment-button.active {
            background-color: var(--attachment-active-bg);
        }

        .attachment-button:hover {
            background-color: var(--secondary-bg);
        }

        .attachment-button.active:hover {
            background-color: var(--attachment-active-bg);
        }

        .send-button {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background-color: var(--accent);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
        }

        .send-button:hover {
            transform: scale(1.1);
            background-color: #6b6b6b;
        }

        .image-generation-confirmation {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            background-color: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 0 auto;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.3s ease-out forwards;
            z-index: 10;
        }

        .image-generation-confirmation.hidden {
            animation: slideUp 0.3s ease-out forwards;
        }

        .confirmation-text {
            flex: 1;
            font-size: 14px;
        }

        .confirm-button, .cancel-button {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
        }

        @keyframes slideDown {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(20px); opacity: 0; }
        }

        .message b {
            font-weight: 600;
        }

        .message i {
            font-style: italic;
        }

        .message ul, .message ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message li {
            margin-bottom: 4px;
        }

        .message h3 {
            font-size: 18px;
            margin: 12px 0 8px;
        }

        .message table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
        }

        .message th, .message td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        .message th {
            background-color: var(--secondary-bg);
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .sidebar {
                position: absolute;
                transform: translateX(-100%);
            }
            
            .sidebar-visible {
                transform: translateX(0);
                box-shadow: 10px 0 20px rgba(0, 0, 0, 0.1);
            }
            
            .close-sidebar {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .chat-container {
                padding: 16px;
            }
            
            .input-container {
                padding: 12px 16px;
            }
            
            .message {
                max-width: 85%;
            }

            .sidebar {
                width: 260px;
            }

            .welcome-buttons {
                flex-direction: column;
                align-items: center;
            }

            .welcome-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .input-wrapper {
                padding: 6px 10px;
            }

            .send-button {
                width: 32px;
                height: 32px;
            }

            .message-input {
                padding: 10px 14px;
            }

            .sidebar {
                width: 100%;
                max-width: 320px;
            }

            .chat-item {
                padding: 10px 12px;
                font-size: 14px;
            }

            .dropdown-item {
                padding: 10px 14px;
                font-size: 14px;
            }

            .attachment-indicator {
                max-width: 200px;
            }

            .attachment-name {
                max-width: 120px;
            }
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
.message-markdown table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    margin: 16px 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    background-color: var(--primary-bg);
}

.message-markdown th,
.message-markdown td {
    padding: 12px 16px;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    transition: background-color 0.3s ease;
}

.message-markdown th {
    background-color: var(--secondary-bg);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent);
}

.message-markdown tr:hover td {
    background-color: rgba(255, 255, 255, 0.05);
}

.message table {
  display: block;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-collapse: separate;
  border-spacing: 0;
  border-radius: 12px;
  margin: 16px 0;
}

.message-markdown th,
.message-markdown td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    color: var(--text-color);
    transition: background-color 0.3s ease;
}

.message-markdown th {
    background-color: var(--secondary-bg);
    font-weight: 600;
    color: var(--accent-color);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.message-markdown tr:hover td {
    background-color: rgba(0, 0, 0, 0.03);
}
.message-wrapper {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 0 16px;
}

.message.user-message {
  align-self: flex-end;
}

.message.bot-message {
  align-self: flex-start;
}
.settings-button svg.brain-icon {
  stroke: var(--text-primary);
  transition: stroke 0.3s ease;
}
.vision-button, .msearch-button {
  background-color: var(--secondary-bg);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  color: var(--text-primary);
  transition: all 0.2s ease;
}

.vision-button:hover, .msearch-button:hover {
  background-color: var(--primary-bg);
}
.active-button {
  border: 2px solid #4D9EF7; /* Borde azul */
  background-color: var(--primary-bg); /* Fondo personalizado */
  color: var(--text-primary); /* Color del texto */
  box-shadow: 0 0 8px rgba(77, 158, 247, 0.6); /* Sombra azul */
  transition: all 0.3s ease; /* Transición suave */
}
.file-reading-indicator {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    background: #f0f4ff;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    font-family: 'Arial', sans-serif;
}
.smart-eye {
    width: 32px;
    height: 32px;
    position: relative;
}
.eye-container {
    width: 100%;
    height: 100%;
    background: linear-gradient(145deg, #3a7bd5, #00d2ff);
    border-radius: 50%;
    position: relative;
    overflow: hidden;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    animation: float 3s ease-in-out infinite;
}
.eyeball {
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    animation: look-around 4s infinite alternate;
}
.pupil {
    width: 8px;
    height: 8px;
    background: #222;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: pupil-move 2s infinite alternate;
}
.eyelid {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(145deg, #3a7bd5, #00d2ff);
    border-radius: 50%;
    top: -100%;
    animation: blink 5s infinite;
}
.scanning-beam {
    position: absolute;
    width: 100%;
    height: 2px;
    background: rgba(255,255,255,0.7);
    top: 0;
    left: 0;
    transform-origin: top center;
    animation: scan 2s infinite;
    box-shadow: 0 0 10px rgba(255,255,255,0.8);
}
.loading-text {
    font-size: 14px;
    color: #333;
    font-weight: 500;
    position: relative;
}
.loading-text::after {
    content: '...';
    position: absolute;
    animation: dots 1.5s infinite steps(4, end);
}
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
@keyframes look-around {
    0% { transform: translate(-30%, -50%); }
    25% { transform: translate(-70%, -50%); }
    50% { transform: translate(-50%, -30%); }
    75% { transform: translate(-50%, -70%); }
    100% { transform: translate(-30%, -50%); }
}
@keyframes pupil-move {
    0%, 100% { transform: translate(-30%, -30%); }
    25% { transform: translate(-70%, -30%); }
    50% { transform: translate(-70%, -70%); }
    75% { transform: translate(-30%, -70%); }
}
@keyframes blink {
    0%, 45%, 50%, 55%, 100% { top: -100%; }
    48%, 52% { top: 0; }
}
@keyframes scan {
    0% { transform: rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    100% { transform: rotate(360deg); opacity: 0; }
}
@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}
.advanced-settings-modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.advanced-settings-modal.active {
  display: flex;
}
.settings-content {
  background: var(--secondary-bg);
  border-radius: 16px;
  width: 90%;
  max-width: 600px;
  padding: 24px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  animation: fadeIn 0.3s ease;
}
.settings-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.close-settings {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--text-primary);
  cursor: pointer;
}
.settings-tabs {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}
.tab-button {
  padding: 10px 16px;
  border: none;
  border-radius: 12px;
  background-color: var(--primary-bg);
  color: var(--text-primary);
  cursor: pointer;
  transition: 0.2s;
}
.tab-button.active {
  background-color: var(--accent);
  color: white;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.settings-body label {
  display: block;
  margin: 6px 0;
}
.settings-body button {
  margin: 10px 0;
  padding: 8px 16px;
  border-radius: 8px;
  background-color: var(--accent);
  color: white;
  border: none;
  cursor: pointer;
}
.settings-body button:hover {
  opacity: 0.9;
}
#toneSelector {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 10px 14px;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  background-color: var(--primary-bg);
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  width: 100%;
  cursor: pointer;
  transition: all 0.3s ease;
  background-image: url('data:image/svg+xml;utf8,<svg fill="%23828282" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
}

#toneSelector:hover {
  border-color: var(--accent);
}

#toneSelector:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(77, 158, 247, 0.4);
}
.table-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.table-modal.visible {
  opacity: 1;
  pointer-events: all;
}

.table-modal-content {
  background: var(--primary-bg);
  max-width: 90%;
  max-height: 80%;
  overflow: auto;
  padding: 20px;
  border-radius: 16px;
  position: relative;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.table-modal-content table {
  width: 100%;
}

.table-modal-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 22px;
  color: var(--text-primary);
  cursor: pointer;
}
.table-modal-content {
  background: var(--message-bg);
  padding: 30px;
  border: 1px solid var(--border-color);
}

    </style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDhUyDQHm4rYrmN0AMh_Jw_WIo0Nev-Kas",
    authDomain: "asclepiouser-120dc.firebaseapp.com",
    projectId: "asclepiouser-120dc",
    storageBucket: "asclepiouser-120dc.firebasestorage.app",
    messagingSenderId: "91797934913",
    appId: "1:91797934913:web:f6634127f41f95898e87c0",
    measurementId: "G-JZZFMW9H6Z"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById("loginScreen").style.display = "none";
      document.querySelector("main").style.display = "flex";
      document.getElementById("profileName").textContent = user.displayName;
      document.getElementById("profileEmail").textContent = user.email;
      document.getElementById("profilePhoto").src = user.photoURL;
      await loadUserChats(user.uid);
    } else {
      document.getElementById("loginScreen").style.display = "flex";
      document.querySelector("main").style.display = "none";
    }
  });

  window.loginWithGoogle = function () {
    signInWithPopup(auth, provider).catch(console.error);
  };

  window.logout = function () {
    signOut(auth);
  };

  async function saveUserChats(uid) {
    await setDoc(doc(db, "users", uid), { chats });
  }

  async function loadUserChats(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
      chats = snap.data().chats || [];
      renderChatList();
      createNewChat();
    }
  }

  setInterval(() => {
    if (auth.currentUser) {
      saveUserChats(auth.currentUser.uid);
    }
  }, 3000);
</script>

</head>
<body>
<div id="loginScreen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: var(--primary-bg); color: var(--text-primary);">
  <h2>Bienvenido a ASCLEPIO 🧠</h2>
  <p>Inicia sesión para guardar tus chats en la nube</p>
  <button onclick="loginWithGoogle()" style="margin-top: 20px; font-size: 16px; padding: 10px 20px;">🔐 Iniciar sesión con Google</button>
</div>

    <div class="html-preview-modal" id="htmlPreviewModal">
        <div class="html-preview-content">
            <div class="html-preview-header">
                <div class="html-preview-title">Vista previa HTML</div>
                <button class="close-preview" onclick="closeHtmlPreview()">✕</button>
            </div>
            <iframe class="html-preview-iframe" id="htmlPreviewIframe" sandbox="allow-scripts"></iframe>
        </div>
    </div>

    <div class="image-modal" id="imageModal">
        <div class="modal-content">
            <img class="modal-image" id="modalImage" src="" alt="Imagen ampliada">
            <button class="close-modal" onclick="closeImageModal()">✕</button>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Chats</div>
            <button class="close-sidebar" onclick="toggleSidebar()">✕</button>
        </div>
        <div class="sidebar-actions">
            <button class="new-chat-button" onclick="createNewChat()">
                <span>+</span> Nuevo chat
            </button>
        </div>
        <ul class="chats-list" id="chatsList"></ul>
        <div class="sidebar-footer">
            <button class="vision-sidebar-button">
                <div class="vision-tooltip">
                    Presentamos Asclepio VISION una herramienta para convertir tus pensamientos e ideas en conceptos visuales, ¡pruebala ya!
                </div>
                <a href="https://diego3117683361.github.io/ASCLEPIOBIOATLAS/" target="_blank" class="vision-link">
                    <span>VISION</span>
                </a>
            </button>
        </div>
    </aside>

    <main class="main-content" style="display: none;">
        <header class="header">
            <button class="menu-button" onclick="toggleSidebar()">☰</button>
            <div class="app-title">A S C L E P I O</div>
        <div class="settings-menu">
    <button class="settings-button" onclick="openAdvancedSettings()" aria-label="Ajustes">
  <svg class="brain-icon" xmlns="http://www.w3.org/2000/svg"
       width="24" height="24" viewBox="0 0 24 24" fill="none"
       stroke="currentColor" stroke-width="2" stroke-linecap="round"
       stroke-linejoin="round">
    <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
    <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
    <path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/>
    <path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/>
    <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/>
    <path d="M3.477 10.896a4 4 0 0 1 .585-.396"/>
    <path d="M19.938 10.5a4 4 0 0 1 .585.396"/>
    <path d="M6 18a4 4 0 0 1-1.967-.516"/>
    <path d="M19.967 17.484A4 4 0 0 1 18 18"/>
  </svg>
</button>
                <div class="settings-dropdown" id="settingsDropdown">
                    <div class="dropdown-item" onclick="toggleTheme()">
                        <span>🔆</span> Cambiar tema
                    </div>
                    <div class="dropdown-item" onclick="clearChat()">
                        <span>🗑️</span> Limpiar chat
                    </div>
                    <div class="dropdown-item" onclick="deleteAllChats()">
                        <span>❌️</span> Eliminar todos los chats
                    </div>
                </div>
            </div>
        </header>

      <div class="chat-container">
  <div class="message-wrapper" id="messages"></div>
</div>

            <div class="attachment-indicator" id="attachmentIndicator">
                <span class="attachment-name" id="attachmentName"></span>
                <button class="attachment-close" onclick="clearAttachment()">✕</button>
            </div>
        </div>

       <div class="input-container" id="inputContainer">
  <!-- ⚠️ Mantener el mensaje flotante para Visión -->
  <div class="image-generation-confirmation hidden" id="imageGenerationConfirmation">
    <div class="confirmation-text">¿Quieres que Asclepio te responda con un concepto visual?</div>
    <button class="confirm-button" onclick="confirmImageGeneration()">✓</button>
    <button class="cancel-button" onclick="cancelImageGeneration()">✕</button>
  </div>

  <!-- 📝 Caja de texto y enviar -->
  <div class="input-wrapper" style="flex-direction: column; gap: 10px;">
    <div class="input-box" style="width: 100%;">
      <input type="text" class="message-input" id="userInput" placeholder="Pregunta lo que quieras" autocomplete="off" />
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 10px;">
  <!-- Botones izquierda -->
  <div style="display: flex; gap: 10px;">
  <button class="msearch-button" id="msearchButton" onclick="toggleActiveButton('msearchButton')">🌐 Msearch</button>
  <button class="vision-button" id="visionButton" onclick="toggleActiveButton('visionButton')">VISION</button>
</div>


  <!-- Botones derecha -->
  <div style="display: flex; gap: 10px;">
    <button class="attachment-button" id="attachmentButton" onclick="toggleAttachment()">
      <svg id="attachmentIcon" width="20" height="20" viewBox="0 0 24 24" fill="none"
           xmlns="http://www.w3.org/2000/svg">
        <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </button>

    <button class="send-button" onclick="sendMessage()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
           fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
           stroke-linejoin="round">
        <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"/>
        <path d="m21.854 2.147-10.94 10.939"/>
      </svg>
    </button>
  </div>
</div>
  </div>
</div>

                <input type="file" id="attachmentInput" accept=".pdf,image/*" style="display: none;">
            </div>
        </div>
<div class="advanced-settings-modal" id="advancedSettingsModal">
  <div class="settings-content">
    <div class="settings-header">
      <h2>Configuración</h2>
      <button class="close-settings" onclick="closeAdvancedSettings()">✕</button>
    </div>
    <div class="settings-tabs">
      <button class="tab-button active" onclick="showSettingsTab('generalTab')">General</button>
      <button class="tab-button" onclick="showSettingsTab('personalizationTab')">Personalización</button>
      <button class="tab-button" onclick="showSettingsTab('profileTab')">Mi Perfil</button>
    </div>
    <div class="settings-body">
      <div id="generalTab" class="tab-content active">
        <h3>Tema</h3>
        <label><input type="radio" name="theme" value="light"> Claro</label><br>
        <label><input type="radio" name="theme" value="dark"> Oscuro</label><br>
        <label><input type="radio" name="theme" value="auto"> Dispositivo</label><br>
        <hr>
        <button onclick="clearChat()">Vaciar chat actual</button>
        <button onclick="deleteAllChats()">Eliminar todos los chats</button>
      </div>
      <div id="personalizationTab" class="tab-content">
        <h3>Tono de respuesta</h3>
        <select id="toneSelector" onchange="setResponseTone()">
          <option value="tradicional">Tradicional</option>
          <option value="profesional">Profesional</option>
          <option value="medico">Experto en medicina</option>
          <option value="amable">Amable e inteligente</option>
          <option value="educador">Educador</option>
        </select>
        <p style="margin-top: 10px; font-style: italic; color: var(--accent);">Próximamente más opciones de personalización...</p>
      </div>
      <div id="profileTab" class="tab-content">
  <h3>Mi Perfil</h3>
  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
    <img id="profilePhoto" src="" alt="Foto de perfil" style="width: 50px; height: 50px; border-radius: 50%;">
    <div>
      <strong id="profileName">Nombre</strong><br>
      <span id="profileEmail" style="font-size: 14px; color: var(--accent);">Correo</span>
    </div>
  </div>
  <button onclick="logout()">🚪 Cerrar sesión</button>
</div>

    </div>
  </div>
</div>
<button id="scrollToBottomBtn" style="
  display: none;
  position: fixed;
  bottom: 100px;
  right: 20px;
  background-color: var(--secondary-bg);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  padding: 10px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 999;
">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none"
       stroke="currentColor" stroke-width="2" stroke-linecap="round"
       stroke-linejoin="round" class="lucide lucide-chevron-down">
    <path d="m6 9 6 6 6-6"/>
  </svg>
</button>

    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.0/tesseract.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        const sidebar = document.getElementById('sidebar');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const chatsList = document.getElementById('chatsList');
        const imageGenerationConfirmation = document.getElementById('imageGenerationConfirmation');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const htmlPreviewModal = document.getElementById('htmlPreviewModal');
        const htmlPreviewIframe = document.getElementById('htmlPreviewIframe');
        const attachmentInput = document.getElementById('attachmentInput');
        const attachmentIndicator = document.getElementById('attachmentIndicator');
        const attachmentName = document.getElementById('attachmentName');
        const attachmentButton = document.getElementById('attachmentButton');
        const attachmentIcon = document.getElementById('attachmentIcon');

        let currentChat = { id: generateId(), messages: [] };
        let chats = [];
        let generateImageFlag = false;
        let hasUserSentMessage = false;
        let lastExtractedText = '';
        let currentAttachmentName = '';
        let isAttachmentActive = false;

        function init() {
            loadTheme();
            loadChats();
            renderChatList();
            createNewChat();
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.settings-menu')) settingsDropdown.classList.remove('visible');
                if (window.innerWidth <= 768 && !e.target.closest('.sidebar') && !e.target.closest('.menu-button')) {
                    sidebar.classList.remove('sidebar-visible');
                }
            });
            userInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') sendMessage(); });
            userInput.addEventListener('input', checkForVisionTrigger);
            window.addEventListener('resize', handleResize);
            attachmentInput.addEventListener('change', handleAttachment);
            
            showWelcomeMessage();
        }

        function toggleAttachment() {
            if (isAttachmentActive) {
                clearAttachment();
                updateAttachmentButton(false);
            } else {
                attachmentInput.click();
            }
        }

        function updateAttachmentButton(active) {
            isAttachmentActive = active;
            attachmentButton.classList.toggle('active', active);
            attachmentIcon.innerHTML = active ?
                `<path d="M6 6L18 18M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>` :
                `<path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
        }

        async function handleAttachment(event) {
            const file = event.target.files[0];
            if (!file) return;

            const processingElement = showDocumentProcessingAnimation();
            let extractedText = '';
            try {
                if (file.type === 'application/pdf') {
                    extractedText = await extractTextFromPDF(file);
                } else if (file.type.startsWith('image/')) {
                    extractedText = await extractTextFromImage(file);
                } else {
                    alert('Por favor, selecciona un PDF o una imagen que contenga texto.');
                    return;
                }

                if (extractedText) {
                    lastExtractedText = extractedText;
                    currentAttachmentName = file.name;
                    showAttachmentIndicator();
                    updateAttachmentButton(true);
                    hideDocumentProcessingAnimation(processingElement);
                    showDocumentSuccessMessage();
                } else {
                    alert('No se pudo extraer texto del archivo.');
                }
            } catch (error) {
                console.error('Error al procesar el archivo:', error);
                alert('Error al procesar el archivo. Intenta con otro.');
            } finally {
                event.target.value = '';
                if (!extractedText) {
                    hideDocumentProcessingAnimation(processingElement);
                }
            }
        }

        function showDocumentProcessingAnimation() {
    const processingDiv = document.createElement('div');
    processingDiv.className = 'document-processing';
    processingDiv.innerHTML = `
        <div class="file-reading-indicator">
            <div class="smart-eye">
                <div class="eye-container">
                    <div class="scanning-beam"></div>
                    <div class="eyeball">
                        <div class="pupil"></div>
                    </div>
                    <div class="eyelid"></div>
                </div>
            </div>
            <span class="loading-text">Procesando archivo</span>
        </div>
    `;
    messagesContainer.appendChild(processingDiv);
    scrollToBottom();
    return processingDiv;
}


        function hideDocumentProcessingAnimation(element) {
            if (element) {
                element.remove();
            }
        }

        function showDocumentSuccessMessage() {
            const successDiv = document.createElement('div');
            successDiv.className = 'document-success bot-message';
            successDiv.innerHTML = `
                Listo, ya he procesado tu archivo, ahora te responderé con base en su contenido
                <button class="success-close" onclick="clearAttachment()">✕</button>
            `;
            messagesContainer.appendChild(successDiv);
            scrollToBottom();
        }

        function showAttachmentIndicator() {
            attachmentName.textContent = currentAttachmentName;
            attachmentIndicator.classList.add('visible');
        }

        function clearAttachment() {
            lastExtractedText = '';
            currentAttachmentName = '';
            attachmentIndicator.classList.remove('visible');
            updateAttachmentButton(false);
            const successMessage = document.querySelector('.document-success');
            if (successMessage) {
                successMessage.remove();
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }

            if (fullText.trim().length > 50) {
                return fullText.trim();
            }

            fullText = '';
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                const imageData = canvas.toDataURL('image/png');
                const { data: { text } } = await Tesseract.recognize(imageData, 'eng');
                fullText += text + '\n\n';
            }

            return fullText.trim();
        }

        async function extractTextFromImage(file) {
            const imageUrl = URL.createObjectURL(file);
            try {
                const { data: { text } } = await Tesseract.recognize(imageUrl, 'eng');
                return text.trim();
            } finally {
                URL.revokeObjectURL(imageUrl);
            }
        }

        function showWelcomeMessage() {
            if (currentChat.messages.length === 0 && !hasUserSentMessage) {
                const hour = new Date().getHours();
                let greeting = 'Buenos días';
                if (hour >= 12 && hour < 18) {
                    greeting = 'Buenas tardes';
                } else if (hour >= 18 || hour < 6) {
                    greeting = 'Buenas noches';
                }
                
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-title">${greeting}</div>
                        <div class="welcome-subtitle">¿Cómo te puedo ayudar?</div>
                        <div class="welcome-buttons">
                            <button class="welcome-btn welcome-btn-image" onclick="setInputText('Crear una imagen')">
                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 16L8.5 10.5L11 13.5L14.5 9L16 11L20 6M4 16H20M4 16V20H20V16" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Crea una imagen
                            </button>
                            <button class="welcome-btn welcome-btn-code" onclick="setInputText('Escribir un código de programación')">
                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 20L14 4M18 8L22 12L18 16M6 16L2 12L6 8" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Escribir código
                            </button>
                            <button class="welcome-btn welcome-btn-analyze" onclick="setInputText('Analiza a profundidad el contenido de este archivo define que tipo de información contiene y en base a eso explíca y uedes usar líneas divisorias, tablas, Puntos clave y conclusiones. Lo importante es que se entienda bien, con un análisis completo y bien desarrollado del contenido.')">
                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 8V12L15 15" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Resumir documento
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function setInputText(text) {
            userInput.value = text;
            userInput.focus();
        }

        function deleteAllChats() {
            if (confirm('¿Estás seguro de que quieres eliminar TODOS los chats? Esta acción no se puede deshacer.')) {
                chats = [];
                lastExtractedText = '';
                currentAttachmentName = '';
                attachmentIndicator.classList.remove('visible');
                updateAttachmentButton(false);
                saveChats();
                createNewChat();
                settingsDropdown.classList.remove('visible');
            }
        }

        function handleResize() {
            if (window.innerWidth >= 768 && sidebar.classList.contains('sidebar-visible')) {
                sidebar.style.boxShadow = 'none';
            } else if (sidebar.classList.contains('sidebar-visible')) {
                sidebar.style.boxShadow = '10px 0 20px rgba(0, 0, 0, 0.1)';
            }
        }
function toggleActiveButton(buttonId) {
  const button = document.getElementById(buttonId);
  button.classList.toggle('active-button'); // Alterna la clase 'active-button'
}

        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-visible');
            if (window.innerWidth <= 768) {
                sidebar.style.boxShadow = sidebar.classList.contains('sidebar-visible') ? '10px 0 20px rgba(0, 0, 0, 0.1)' : 'none';
            } else {
                sidebar.style.boxShadow = 'none';
            }
        }

        function toggleSettings() {
            settingsDropdown.classList.toggle('visible');
        }

        function toggleTheme() {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            settingsDropdown.classList.remove('visible');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function loadChats() {
            const savedChats = localStorage.getItem('chats');
            if (savedChats) chats = JSON.parse(savedChats);
        }

        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        function renderChatList() {
            chatsList.innerHTML = chats.length === 0 ? '<div style="padding: 16px; color: var(--text-primary); opacity: 0.7;">No hay chats guardados</div>' : '';
            chats.forEach(chat => {
                const chatItem = document.createElement('li');
                chatItem.className = 'chat-item';
                chatItem.innerHTML = `
                    <div class="chat-item-icon">${chat.messages[0]?.text.substring(0, 1).toUpperCase() || '?'}</div>
                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${chat.messages[0]?.text.substring(0, 30) || 'Nuevo chat'}...
                    </div>
                    <button class="delete-chat" onclick="deleteChat(event, '${chat.id}')">✕</button>
                `;
                chatItem.addEventListener('click', () => loadChat(chat.id));
                chatsList.appendChild(chatItem);
            });
        }

        function loadChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                currentChat = chat;
                renderMessages(chat.messages);
                toggleSidebar();
                hasUserSentMessage = chat.messages.length > 0;
                if (!hasUserSentMessage) {
                    showWelcomeMessage();
                }
            }
        }

        function createNewChat() {
            if (currentChat.messages.length === 0 && !hasUserSentMessage) {
                return;
            }
            
            currentChat = { id: generateId(), messages: [] };
            chats.push(currentChat);
            saveChats();
            renderChatList();
            messagesContainer.innerHTML = '';
            hasUserSentMessage = false;
            showWelcomeMessage();
            userInput.focus();
            clearAttachment();
        }

        function deleteChat(event, chatId) {
            event.stopPropagation();
            if (confirm('¿Estás seguro de que quieres eliminar este chat?')) {
                chats = chats.filter(c => c.id !== chatId);
                saveChats();
                if (currentChat.id === chatId) {
                    if (chats.length > 0) {
                        currentChat = chats[chats.length - 1];
                        renderMessages(currentChat.messages);
                        hasUserSentMessage = currentChat.messages.length > 0;
                    } else {
                        createNewChat();
                    }
                }
                renderChatList();
            }
        }

        function clearChat() {
            if (confirm('¿Estás seguro de que quieres limpiar este chat?')) {
                currentChat.messages = [];
                lastExtractedText = '';
                currentAttachmentName = '';
                attachmentIndicator.classList.remove('visible');
                updateAttachmentButton(false);
                renderMessages([]);
                settingsDropdown.classList.remove('visible');
                saveChats();
                hasUserSentMessage = false;
                showWelcomeMessage();
            }
        }

        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (!messageText && !lastExtractedText) return;

            hasUserSentMessage = true;

            let fullMessageText = messageText;
if (currentChat.messages.length === 0) {
  const tone = localStorage.getItem('asclepioTone');
  if (tone === 'profesional') {
    fullMessageText = "Responde siempre con un tono profesional y claro, siempre de manera muy elegante. Utiliza un lenguaje formal pero accesible, evitando jargon innecesario.\n\nSi la información requiere estructuración compleja (comparaciones, datos numéricos, pasos detallados, etc.), puedes organizarla en tablas o con líneas divisoras gráficas para mejorar la legibilidad. Sin embargo, evítalas si el contenido es breve o no lo amerita.\n\nPrioriza la claridad y la eficiencia en tus respuestas, adaptándote al contexto de la consulta.\n\n" + fullMessageText;
  } else if (tone === 'medico') {
    fullMessageText = "Responde todo como un experto médico, utilizando terminología clínica precisa y basándote en evidencia científica. Mantén un tono profesional y accesible para colegas del ámbito sanitario, puedes emplear emojis solo si refuerzan la claridad, además usa tablas, líneas divisoras para mejorar la legibilidad en caso de ser necesarias además cuando se pregunte un tema en específico comparte links en donde el usuario pueda ampliar esa información\n\n" + fullMessageText;
  } else if (tone === 'amable') {
    fullMessageText = "Quiero que respondas como un amigo experto 🤓: claro, súper amable y 100% enfocado en que entienda todo fácilmente. Usa explicaciones sencillas (sin tecnicismos innecesarios), emojis para hacerlo más divertido 🚀✨ y tablas o gráficos solo si ayudan a visualizar mejor (ej.: pasos, comparaciones). También verifica si entendí, ofreciendo ampliar info con frases como '¿Quedó claro o lo explico de otra forma? 🔍' o '¿Quieres que profundice en algo? 🛠️', y si algo es complejo, simplifícalo como si fuera una charla entre amigos. Prioriza hacerme sentir que aprendo sin esfuerzo, usando ejemplos cotidianos y un tono motivador (ej.: '¡Buena pregunta! 👀 Aquí va el dato clave…'). Si dudas, elige la opción más clara, no la más técnica. ¡Haz que el conocimiento se sienta ligero y entretenido! 😎\n\n" + fullMessageText;
  }
}

            let hasAttachment = false;

            if (lastExtractedText) {
                fullMessageText = `${messageText}\n\n[MENSAJE PARA MEJOR ENTENDIMIENTO: EL USUARIO CARGÓ UN ARCHIVO Y DE SE ARCHIVO SE EXTRAJO EL SIGUIENTE TEXTO ASÍ QUE LA PREGUNTA DEBE RESPONDERSE EN BASE A ESTE TEXTO ANTES DE RESPONDER ANALÍZALO Y SI POR EJEMPLO CONTIENE PREGUNTAS RESUELVELAS DE MANERA ORDENADA Y SOLO CONTIENE INFORMACIÓN SOBRE UN TEMA RESPONDE LA PREGUNTA DEL USUARIO O HAZ UN RESUMEN]:\n${lastExtractedText}`;
                hasAttachment = true;
            }

            const userMessage = { 
                sender: 'user', 
                text: messageText,
                timestamp: new Date().toISOString(),
                hasAttachment: hasAttachment
            };
            currentChat.messages.push(userMessage);
            renderMessage(userMessage);
            userInput.value = '';

            const isVisionMode = document.getElementById('visionButton').classList.contains('active-button');

if (isVisionMode) {
    const loadingElement = showImageLoadingAnimation();
    try {
        const imageUrl = await generateImage(fullMessageText);
        const imageHtml = `
            <div class="generated-image-container">
                <img src="${imageUrl}" alt="Imagen generada por Asclepio" class="generated-image">
                <button class="download-button" onclick="downloadImage('${imageUrl}')">Descargar imagen</button>
                <div class="image-prompt">Prompt: "${messageText}"</div>
            </div>
        `;
        const botMessage = {
            sender: 'bot',
            text: imageHtml,
            timestamp: new Date().toISOString(),
            isImage: true,
            imageUrl: imageUrl
        };
        currentChat.messages.push(botMessage);
        renderMessage(botMessage);
        setupImageInteractions();
    } catch (error) {
        const errorMessage = {
            sender: 'bot',
            text: "¡Uy! La imagen se nos escapó como si tuviera patas 🎨💨. No se pudo crear esta vez, pero puedes intentar de nuevo en un rato… o empezar un nuevo chat y darle otra oportunidad a la inspiración digital 💫📷. Detalles: " + error.message,
            timestamp: new Date().toISOString()
        };
        currentChat.messages.push(errorMessage);
        renderMessage(errorMessage);
    } finally {
        hideImageLoadingAnimation(loadingElement);
    }
} else {
                const typingIndicator = showTypingIndicator();
                try {
                   const conversationHistory = currentChat.messages
    .map(msg => `${msg.sender === 'user' ? 'Usuario' : 'Asclepio'}: ${msg.text}`)
    .join('\n');

const response = await fetch('https://magicloops.dev/api/loop/1f758d92-e471-4272-b993-b7db9f72a008/run', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ question: conversationHistory + '\nUsuario: ' + fullMessageText })

});

                    const responseData = await response.json();
                    const botResponse = responseData.answer || JSON.stringify(responseData);
                    const botMessage = { sender: 'bot', text: botResponse, timestamp: new Date().toISOString() };
                    currentChat.messages.push(botMessage);
                    typeMessage(botMessage);
                } catch (error) {
                    const errorMessage = { sender: 'bot', text: "¡Ups! Asclepio se fue a tomar un cafecito con el Wi-Fi ☕📡... Parece que la conexión se nos resbaló como jabón en regadera. Intenta de nuevo en unos segundos, o intenta crear un nuevo chat y cruzamos los dedos", timestamp: new Date().toISOString() };
                    currentChat.messages.push(errorMessage);
                    typeMessage(errorMessage);
                } finally {
                    hideTypingIndicator(typingIndicator);
                }
            }

            if (!chats.some(c => c.id === currentChat.id)) chats.push(currentChat);
            saveChats();
            renderChatList();
        }

        async function generateImage(prompt) {
            const url = 'https://magicloops.dev/api/loop/1672deeb-46fb-4017-a9ce-2251502f19b2/run';
            const payload = { prompt: prompt };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.status} - ${response.statusText}`);
                }
                const responseData = await response.json();
                let imageUrl = responseData.url || responseData.imageUrl || responseData.data?.image?.url;
                if (!imageUrl && typeof responseData === 'string') {
                    imageUrl = responseData;
                }
                if (!imageUrl) {
                    throw new Error("No se encontró la URL de la imagen en la respuesta.");
                }
                return imageUrl;
            } catch (error) {
                throw error;
            }
        }

        function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            if (messages.length === 0 && !hasUserSentMessage) {
                showWelcomeMessage();
            } else {
                if (currentAttachmentName) {
                    showAttachmentIndicator();
                    showDocumentSuccessMessage();
                }
                messages.forEach(msg => renderMessage(msg));
            }
            scrollToBottom();
            setupImageInteractions();
        }

        function renderMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender}-message`;
            
            if (message.isImage) {
                messageDiv.innerHTML = message.text;
                const img = messageDiv.querySelector('.generated-image');
                if (img) {
                    img.addEventListener('click', () => openImageModal(message.imageUrl));
                }
            } else {
                const containsHtml = /<[a-z][\s\S]*>/i.test(message.text);
                if (containsHtml && !message.text.includes('<div class="generated-image-container">')) {
                    messageDiv.innerHTML = `
                        <div class="html-container">
                            <div class="html-toolbar">
                                <div class="html-toolbar-title">HTML</div>
                                <div class="html-toolbar-buttons">
                                    <button class="html-toolbar-btn" onclick="copyHtmlToClipboard(this, '${escapeHtml(message.text)}')">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8 17.929H6C4.89543 17.929 4 17.0336 4 15.929V5.929C4 4.82443 4.89543 3.929 6 3.929H14C15.1046 3.929 16 4.82443 16 5.929V7.929M10 7.929H18C19.1046 7.929 20 8.82443 20 9.929V19.929C20 21.0336 19.1046 21.929 18 21.929H10C8.89543 21.929 8 21.0336 8 19.929V9.929C8 8.82443 8.89543 7.929 10 7.929Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Copiar
                                    </button>
                                    <button class="html-toolbar-btn" onclick="previewHtml('${escapeHtml(message.text)}')">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        Vista previa
                                    </button>
                                </div>
                            </div>
                            <div class="html-content">${escapeHtml(message.text)}</div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = formatText(message.text);
                    if (message.hasAttachment) {
                        messageDiv.innerHTML += `<span class="message-attachment-indicator">📑</span>`;
                    }
                }
            }
            
            if (message.sender === 'bot' && !message.isImage && !message.text.includes('<div class="html-container">')) {
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'Copiar';
                copyButton.title = 'Copiar al portapapeles';
                copyButton.onclick = () => copyToClipboard(message.text);
                messageDiv.appendChild(copyButton);
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function setupImageInteractions() {
            const imageContainers = document.querySelectorAll('.generated-image-container');
            imageContainers.forEach(container => {
                const img = container.querySelector('.generated-image');
                let pressTimer;

                const startPress = () => {
                    pressTimer = setTimeout(() => {
                        container.classList.add('active');
                    }, 500);
                };

                const endPress = () => {
                    clearTimeout(pressTimer);
                    setTimeout(() => {
                        container.classList.remove('active');
                    }, 5000);
                };

                img.addEventListener('mousedown', startPress);
                img.addEventListener('mouseup', endPress);
                img.addEventListener('mouseleave', endPress);
                img.addEventListener('touchstart', startPress);
                img.addEventListener('touchend', endPress);
                img.addEventListener('touchcancel', endPress);
            });
        }

        function downloadImage(imageUrl) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = 'asclepio-image.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function copyHtmlToClipboard(button, html) {
            navigator.clipboard.writeText(html).then(() => {
                button.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Copiado
                `;
                setTimeout(() => {
                    button.innerHTML = `
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 17.929H6C4.89543 17.929 4 17.0336 4 15.929V5.929C4 4.82443 4.89543 3.929 6 3.929H14C15.1046 3.929 16 4.82443 16 5.929V7.929M10 7.929H18C19.1046 7.929 20 8.82443 20 9.929V19.929C20 21.0336 19.1046 21.929 18 21.929H10C8.89543 21.929 8 21.0336 8 19.929V9.929C8 8.82443 8.89543 7.929 10 7.929Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Copiar
                    `;
                }, 2000);
            }).catch(err => console.error('Error al copiar: ', err));
        }

        function previewHtml(html) {
            const iframeDoc = htmlPreviewIframe.contentDocument || htmlPreviewIframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(html);
            iframeDoc.close();
            htmlPreviewModal.classList.add('visible');
        }

        function closeHtmlPreview() {
            htmlPreviewModal.classList.remove('visible');
        }

        function typeMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender}-message`;
            messagesContainer.appendChild(messageDiv);
            let i = 0;
            const fullText = formatText(message.text);
            const typingSpeed = 10;
            const typingInterval = setInterval(() => {
                if (i < fullText.length) {
                    messageDiv.innerHTML = fullText.substring(0, i + 1);
                    if (i === fullText.length - 1 && message.sender === 'bot') {
                        const containsHtml = /<[a-z][\s\S]*>/i.test(message.text);
                        if (!containsHtml) {
                            const copyButton = document.createElement('button');
                            copyButton.className = 'copy-button';
                            copyButton.textContent = 'Copiar';
                            copyButton.title = 'Copiar al portapapeles';
                            copyButton.onclick = () => copyToClipboard(message.text);
                            messageDiv.appendChild(copyButton);
                        }
                    }
                    i++;
                    scrollToBottom();
                } else {
                    clearInterval(typingInterval);
                }
            }, typingSpeed);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const copyButtons = document.querySelectorAll('.copy-button');
                copyButtons.forEach(button => {
                    if (button.textContent === 'Copiar') {
                        button.textContent = '¡Copiado!';
                        setTimeout(() => button.textContent = 'Copiar', 2000);
                    }
                });
            }).catch(err => console.error('Error al copiar: ', err));
        }

        function openImageModal(imageUrl) {
            modalImage.src = imageUrl;
            imageModal.classList.add('visible');
        }

        function closeImageModal() {
            imageModal.classList.remove('visible');
        }

        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeImageModal();
            }
        });

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
            return typingDiv;
        }

        function hideTypingIndicator(typingElement) {
            typingElement.remove();
        }

        function showImageLoadingAnimation() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'image-loading';
            loadingDiv.innerHTML = `
                <div class="sketch-container">
                    <div class="sketch-pencil"></div>
                    <div class="sketch-line"></div>
                    <div class="sketch-line"></div>
                    <div class="sketch-line"></div>
                    <div class="sketch-line"></div>
                </div>
                <div class="loading-text">Dibujando tu concepto visual...</div>
            `;
            messagesContainer.appendChild(loadingDiv);
            scrollToBottom();
            return loadingDiv;
        }

        function hideImageLoadingAnimation(loadingElement) {
            loadingElement.remove();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function checkForVisionTrigger() {
            const text = userInput.value.toLowerCase();
            const triggerWords = ['crear', 'crea', 'ilustra', 'dibuja', 'genera', 'imagen'];
            if (triggerWords.some(word => text.includes(word))) {
                showImageGenerationConfirmation();
            } else {
                hideImageGenerationConfirmation();
            }
        }

        function showImageGenerationConfirmation() {
            imageGenerationConfirmation.classList.remove('hidden');
        }

        function hideImageGenerationConfirmation() {
            imageGenerationConfirmation.classList.add('hidden');
        }

       function confirmImageGeneration() {
    const visionBtn = document.getElementById('visionButton');
    visionBtn.classList.add('active-button'); // activa el botón de visión
    imageGenerationConfirmation.classList.add('hidden'); // oculta el anuncio
}

 
        function cancelImageGeneration() {
    imageGenerationConfirmation.classList.add('hidden'); // solo oculta el anuncio
}

      function formatText(text) {
    if (typeof text !== 'string') return text;

    // Intenta detectar si el contenido es un JSON plano tipo: "texto\ntexto"
    try {
        const parsed = JSON.parse(text);
        if (typeof parsed === 'string') {
            text = parsed;
        }
    } catch (e) {
        // No era JSON, no pasa nada
    }

    // Reemplaza los "\n" literales por saltos reales
    const cleanedText = text.replace(/\\n/g, '\n');

    // Usa marked para renderizar como Markdown
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            gfm: true,
            breaks: true,
            headerIds: false
        });
        const html = marked.parse(cleanedText);
        return `<div class="message-markdown">${html}</div>`;
    }

    return `<p>${cleanedText}</p>`;
}



        init();
function openAdvancedSettings() {
  document.getElementById('advancedSettingsModal').classList.add('active');
  const savedTone = localStorage.getItem('asclepioTone');
  if (savedTone) document.getElementById('toneSelector').value = savedTone;
}

function closeAdvancedSettings() {
  document.getElementById('advancedSettingsModal').classList.remove('active');
}

function showSettingsTab(tabId) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');

  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
}

function setResponseTone() {
  const tone = document.getElementById('toneSelector').value;
  localStorage.setItem('asclepioTone', tone);
}

// 👇 Aplicar tema desde la sección general
document.querySelectorAll('input[name="theme"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    const theme = e.target.value;
    if (theme === 'auto') {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    } else {
      document.documentElement.setAttribute('data-theme', theme);
    }
    localStorage.setItem('theme', theme);
  });
});
const scrollBtn = document.getElementById('scrollToBottomBtn');
const chatContainer = document.querySelector('.chat-container');

chatContainer.addEventListener('scroll', () => {
  const atBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 10;
  scrollBtn.style.display = atBottom ? 'none' : 'block';
});

scrollBtn.addEventListener('click', () => {
  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
});
function openTableModal(tableHtml) {
  const modal = document.getElementById("tableModal");
  const content = document.getElementById("tableModalContent");
  content.innerHTML = `<div class="message-markdown">${tableHtml}</div>`;
  modal.classList.add("visible");
}

function closeTableModal() {
  document.getElementById("tableModal").classList.remove("visible");
}

// Delegar clic en tablas dentro del contenedor de mensajes
messagesContainer.addEventListener("click", (e) => {
  const clickedTable = e.target.closest("table");
  if (clickedTable && messagesContainer.contains(clickedTable)) {
    openTableModal(clickedTable.outerHTML);
  }
});

    </script>
<div id="tableModal" class="table-modal">
  <div class="table-modal-content">
    <button class="table-modal-close" onclick="closeTableModal()">✕</button>
    <div id="tableModalContent"></div>
  </div>
</div>

</body>
</html>
